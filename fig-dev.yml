#
# Development server with ssh configured to run on port 1822
# and the django runserver on port 1823
# The database run on port 15432
#
# Usage:
# fig -f fig-dev.yml <command>
#
# Be sure to build the production docker uwsgi container first as the dev
# one inherits from that.
#
# Typical useage:
#
# fig -f fig-dev.yml build
# fig -f fig-dev.yml up -d dev
# fig -f fig-dev.yml run devmigrate
# fig -f fig-dev.yml run devcollectstatic


# To get an interactive shell in the django context:
#
# fig -f fig-dev.yml run devshell

#
# Local development server
#
devdb:
  image: kartoza/postgis
  environment:
    - USERNAME=docker
    - PASS=docker
  ports:
    - "15432:5432"

dev:
  build: docker-dev
  environment:
    - DATABASE_NAME=gis
    - DATABASE_USERNAME=docker
    - DATABASE_PASSWORD=docker
    - DATABASE_HOST=db
    - DJANGO_SETTINGS_MODULE=core.settings.dev_docker
  volumes:
    - django_project:/home/web
  ports:
    - "1822:22"
    - "1823:1723"
  links:
    - devdb:db

devmigrate:
  build: docker-dev
  hostname: devmigrate
  entrypoint: /usr/bin/python
  command: "/home/web/manage.py migrate"
  environment:
    - DATABASE_NAME=gis
    - DATABASE_USERNAME=docker
    - DATABASE_PASSWORD=docker
    - DATABASE_HOST=db
    - DJANGO_SETTINGS_MODULE=core.settings.dev_docker
  volumes:
    - django_project:/home/web
  links:
    - devdb:db

devcollectstatic:
  build: docker-dev
  hostname: devcollectstatic
  entrypoint: /usr/bin/python
  command: "/home/web/manage.py collectstatic --noinput"
  environment:
    - DATABASE_NAME=gis
    - DATABASE_USERNAME=docker
    - DATABASE_PASSWORD=docker
    - DATABASE_HOST=db
    - DJANGO_SETTINGS_MODULE=core.settings.dev_docker
  volumes:
    - django_project:/home/web
  links:
    - devdb:db

devshell:
  build: docker-dev
  hostname: devshell
  entrypoint: /bin/bash
  command: -i
  environment:
    - DATABASE_NAME=gis
    - DATABASE_USERNAME=docker
    - DATABASE_PASSWORD=docker
    - DATABASE_HOST=db
    - DJANGO_SETTINGS_MODULE=core.settings.dev_docker
  volumes:
    - django_project:/home/web
  links:
    - devdb:db
